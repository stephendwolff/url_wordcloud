function flatten(c,d){if("string"==typeof c){return c}var f=[];for(d in c){var b=flatten(c[d],d);b&&f.push(b)}return f.join(" ")}function parseText(a){tags={};var b={},c=false;a.split(c?/\n/g:wordSeparators).forEach(function(d){discard.test(d)||(c||(d=d.replace(punctuation,"")),stopWords.test(d.toLowerCase())||(d=d.substr(0,maxLength),b[d.toLowerCase()]=d,tags[d=d.toLowerCase()]=(tags[d]||0)+1))}),tags=d3.entries(tags).sort(function(d,f){return f.value-d.value}),tags.forEach(function(d){d.key=b[d.key]}),generate()}function updateTags(a){var c={};for(var b in a){c[b.toLowerCase()]=b;tags[b=b.toLowerCase()]=(tags[b]||0)+1}tags=d3.entries(a).sort(function(d,f){return f.value-d.value}),tags.forEach(function(d){d.key=c[d.key]}),generate()}function generate(){layout.font("Impact").spiral("archimedean"),fontSize=d3.scale.log().range([10,100]),tags.length&&fontSize.domain([+tags[tags.length-1].value||1,+tags[0].value]),complete=0,statusText.style("display",null),words=[],layout.stop().words(tags.slice(0,max=Math.min(tags.length,250))).start()}function progress(a){statusText.text(++complete+"/"+max)}function draw(c,f){statusText.style("display","none"),scale=f?Math.min(w/Math.abs(f[1].x-w/2),w/Math.abs(f[0].x-w/2),h/Math.abs(f[1].y-h/2),h/Math.abs(f[0].y-h/2))/2:1,words=c;var g=vis.selectAll("text").data(words,function(a){return a.text.toLowerCase()});g.transition().duration(1000).attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).style("font-size",function(a){return a.size+"px"}),g.enter().append("text").attr("text-anchor","middle").attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).style("font-size","1px").transition().duration(1000).style("font-size",function(a){return a.size+"px"}),g.style("font-family",function(a){return a.font}).style("fill",function(a){return fill(a.text.toLowerCase())}).text(function(a){return a.text});var b=background.append("g").attr("transform",vis.attr("transform")),d=b.node();g.exit().each(function(){d.appendChild(this)}),b.transition().duration(1000).style("opacity",0.000001).remove(),vis.transition().delay(1000).duration(750).attr("transform","translate("+[w>>1,h>>1]+")scale("+scale+")")}function downloadPNG(){d3.event.preventDefault();var a=document.createElement("canvas"),b=a.getContext("2d");a.width=w,a.height=h,b.translate(w>>1,h>>1),b.scale(scale,scale),words.forEach(function(c,d){b.save(),b.translate(c.x,c.y),b.rotate(c.rotate*Math.PI/180),b.textAlign="center",b.fillStyle=fill(c.text.toLowerCase()),b.font=c.size+"px "+c.font,b.fillText(c.text,0,0),b.restore()}),echoContentType.attr("value","image/png"),echoInput.attr("value",a.toDataURL("image/png")),echoForm.node().submit()}function downloadSVG(){d3.event.preventDefault(),echoContentType.attr("value","image/svg+xml;charset=utf-8"),echoInput.attr("value",svg.attr("version","1.1").attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML),echoForm.node().submit()}!function(B){function O(){function S(Z,af,ao){for(var ab,ae,aa,ag=([{x:0,y:0},{x:l[0],y:l[1]}],af.x),ai=af.y,am=Math.sqrt(l[0]*l[0]+l[1]*l[1]),aj=c(l),al=Math.random()<0.5?1:-1,ad=-al;(ab=aj(ad+=al))&&(ae=~~ab[0],aa=~~ab[1],!(Math.min(ae,aa)>am));){if(af.x=ag+ae,af.y=ai+aa,!(af.x+af.x0<0||af.y+af.y0<0||af.x+af.x1>l[0]||af.y+af.y1>l[1])&&(!ao||!A(af,Z,l[0]))&&(!ao||Q(af,ao))){for(var V,ak=af.sprite,Y=af.width>>5,W=l[0]>>5,X=af.x-(Y<<4),m=127&X,an=32-m,U=af.y1-af.y0,ah=(af.y+af.y0)*W+(X>>5),e=0;U>e;e++){V=0;for(var ac=0;Y>=ac;ac++){Z[ah+ac]|=V<<an|(Y>ac?(V=ak[e*Y+ac])>>>m:0)}ah+=W}return delete af.sprite,!0}}return !1}var l=[256,256],f=G,a=R,r=D,i=F,M=C,c=P,s=[],u=1/0,o=d3.dispatch("word","end"),n=null,d={};return d.start=function(){function x(){for(var T,y=+new Date;+new Date-y<u&&++g<t&&n;){T=p[g],T.x=l[0]*(Math.random()+0.5)>>1,T.y=l[1]*(Math.random()+0.5)>>1,I(T,p,g),S(e,T,m)&&(v.push(T),o.word(T),m?J(m,T):m=[{x:T.x+T.x0,y:T.y+T.y0},{x:T.x+T.x1,y:T.y+T.y1}],T.x-=l[0]>>1,T.y-=l[1]>>1)}g>=t&&(d.stop(),o.end(v,m))}var e=N((l[0]>>5)*l[1]),m=null,t=s.length,g=-1,v=[],p=s.map(function(y,T){return{text:f.call(this,y,T),font:a.call(this,y,T),rotate:i.call(this,y,T),size:~~r.call(this,y,T),padding:C.call(this,y,T)}}).sort(function(y,T){return T.size-y.size});return n&&clearInterval(n),n=setInterval(x,0),x(),d},d.stop=function(){return n&&(clearInterval(n),n=null),d},d.timeInterval=function(e){return arguments.length?(u=null==e?1/0:e,d):u},d.words=function(e){return arguments.length?(s=e,d):s},d.size=function(e){return arguments.length?(l=[+e[0],+e[1]],d):l},d.font=function(e){return arguments.length?(a=d3.functor(e),d):a},d.rotate=function(e){return arguments.length?(i=d3.functor(e),d):i},d.text=function(e){return arguments.length?(f=d3.functor(e),d):f},d.spiral=function(e){return arguments.length?(c=b[e+""]||e,d):c},d.fontSize=function(e){return arguments.length?(r=d3.functor(e),d):r},d.padding=function(e){return arguments.length?(M=d3.functor(e),d):M},d3.rebind(d,o,"on")}function G(a){return a.text}function R(){return"serif"}function D(a){return Math.sqrt(a.value)}function F(){return 30*(~~(6*Math.random())-3)}function C(){return 1}function I(X,ak,ae){if(!X.sprite){q.clearRect(0,0,(L<<5)/H,z/H);var ao=0,aa=0,ad=0,Y=ak.length;for(ae--;++ae<Y;){X=ak[ae],q.save(),q.font=~~((X.size+1)/H)+"px "+X.font;var af=q.measureText(X.text+"m").width*H,W=X.size<<1;if(X.rotate){var ah=Math.sin(X.rotate*j),am=Math.cos(X.rotate*j),al=af*am,ai=af*ah,aj=W*am,ac=W*ah;af=Math.max(Math.abs(al+ac),Math.abs(al-ac))+31>>5<<5,W=~~Math.max(Math.abs(ai+aj),Math.abs(ai-aj))}else{af=af+31>>5<<5}if(W>ad&&(ad=W),ao+af>=L<<5&&(ao=0,aa+=ad,ad=0),aa+W>=z){break}q.translate((ao+(af>>1))/H,(aa+(W>>1))/H),X.rotate&&q.rotate(X.rotate*j),q.fillText(X.text,0,0),q.restore(),X.width=af,X.height=W,X.xoff=ao,X.yoff=aa,X.x1=af>>1,X.y1=W>>1,X.x0=-X.x1,X.y0=-X.y1,ao+=af}for(var V=q.getImageData(0,0,(L<<5)/H,z/H).data,v=[];--ae>=0;){X=ak[ae];for(var af=X.width,an=af>>5,W=X.y1-X.y0,y=X.padding,ag=0;W*an>ag;ag++){v[ag]=0}if(ao=X.xoff,null==ao){return}aa=X.yoff;for(var g=0,ab=-1,Z=0;W>Z;Z++){for(var ag=0;af>ag;ag++){var m=an*Z+(ag>>5),U=V[(aa+Z)*(L<<5)+(ao+ag)<<2]?1<<31-ag%32:0;y&&(Z&&(v[m-an]|=U),af-1>Z&&(v[m+an]|=U),U|=U<<1|U>>1),v[m]|=U,g|=U}g?ab=Z:(X.y0++,W--,Z--,aa++)}X.y1=X.y0+ab,X.sprite=v.slice(0,(X.y1-X.y0)*an)}}}function A(V,y,m){m>>=5;for(var T,f=V.sprite,g=V.width>>5,W=V.x-(g<<4),p=127&W,U=32-p,v=V.y1-V.y0,S=(V.y+V.y0)*m+(W>>5),M=0;v>M;M++){T=0;for(var x=0;g>=x;x++){if((T<<U|(g>x?(T=f[M*g+x])>>>p:0))&y[S+x]){return !0}}S+=m}return !1}function J(d,f){var g=d[0],c=d[1];f.x+f.x0<g.x&&(g.x=f.x+f.x0),f.y+f.y0<g.y&&(g.y=f.y+f.y0),f.x+f.x1>c.x&&(c.x=f.x+f.x1),f.y+f.y1>c.y&&(c.y=f.y+f.y1)}function Q(a,c){return a.x+a.x1>c[0].x&&a.x+a.x0<c[1].x&&a.y+a.y1>c[0].y&&a.y+a.y0<c[1].y}function P(a){var c=a[0]/a[1];return function(d){return[c*(d*=0.1)*Math.cos(d),d*Math.sin(d)]}}function K(d){var g=4,i=g*d[0]/d[1],c=0,f=0;return function(a){var e=0>a?-1:1;switch(Math.sqrt(1+4*e*a)-e&3){case 0:c+=i;break;case 1:f+=g;break;case 2:c-=i;break;default:f-=g}return[c,f]}}function N(a){for(var c=[],d=-1;++d<a;){c[d]=0}return c}var E,j=Math.PI/180,L=64,z=2048,H=1;if("undefined"!=typeof document){E=document.createElement("canvas"),E.width=1,E.height=1,H=Math.sqrt(E.getContext("2d").getImageData(0,0,1,1).data.length>>2),E.width=(L<<5)/H,E.height=z/H}else{var k=require("canvas");E=new k(L<<5,z)}var q=E.getContext("2d"),b={archimedean:P,rectangular:K};q.fillStyle="red",q.textAlign="center",B.cloud=O}("undefined"==typeof exports?d3.layout||(d3.layout={}):exports);var unicodePunctuationRe="!-#%-*,-/:;?@\\[-\\]_{}\xa1\xa7\xab\xb6\xb7\xbb\xbf\u037e\u0387\u055a-\u055f\u0589\u058a\u05be\u05c0\u05c3\u05c6\u05f3\u05f4\u0609\u060a\u060c\u060d\u061b\u061e\u061f\u066a-\u066d\u06d4\u0700-\u070d\u07f7-\u07f9\u0830-\u083e\u085e\u0964\u0965\u0970\u0af0\u0df4\u0e4f\u0e5a\u0e5b\u0f04-\u0f12\u0f14\u0f3a-\u0f3d\u0f85\u0fd0-\u0fd4\u0fd9\u0fda\u104a-\u104f\u10fb\u1360-\u1368\u1400\u166d\u166e\u169b\u169c\u16eb-\u16ed\u1735\u1736\u17d4-\u17d6\u17d8-\u17da\u1800-\u180a\u1944\u1945\u1a1e\u1a1f\u1aa0-\u1aa6\u1aa8-\u1aad\u1b5a-\u1b60\u1bfc-\u1bff\u1c3b-\u1c3f\u1c7e\u1c7f\u1cc0-\u1cc7\u1cd3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205e\u207d\u207e\u208d\u208e\u2329\u232a\u2768-\u2775\u27c5\u27c6\u27e6-\u27ef\u2983-\u2998\u29d8-\u29db\u29fc\u29fd\u2cf9-\u2cfc\u2cfe\u2cff\u2d70\u2e00-\u2e2e\u2e30-\u2e3b\u3001-\u3003\u3008-\u3011\u3014-\u301f\u3030\u303d\u30a0\u30fb\ua4fe\ua4ff\ua60d-\ua60f\ua673\ua67e\ua6f2-\ua6f7\ua874-\ua877\ua8ce\ua8cf\ua8f8-\ua8fa\ua92e\ua92f\ua95f\ua9c1-\ua9cd\ua9de\ua9df\uaa5c-\uaa5f\uaade\uaadf\uaaf0\uaaf1\uabeb\ufd3e\ufd3f\ufe10-\ufe19\ufe30-\ufe52\ufe54-\ufe61\ufe63\ufe68\ufe6a\ufe6b\uff01-\uff03\uff05-\uff0a\uff0c-\uff0f\uff1a\uff1b\uff1f\uff20\uff3b-\uff3d\uff3f\uff5b\uff5d\uff5f-\uff65",fill=d3.scale.category20b(),w=960,h=600,words=[],max,scale=1,complete=0,keyword="",tags,fontSize,maxLength=30,fetcher,statusText=d3.select("#status"),layout=d3.layout.cloud().timeInterval(10).size([w,h]).fontSize(function(a){return fontSize(+a.value)}).text(function(a){return a.key}).on("word",progress).on("end",draw),svg=d3.select("#vis").append("svg").attr("width",w).attr("height",h),background=svg.append("g"),vis=svg.append("g").attr("transform","translate("+[w>>1,h>>1]+")");d3.select("#download-svg").on("click",downloadSVG),d3.select("#download-png").on("click",downloadPNG);var form=d3.select("#form").on("submit",function(){parseText(d3.select("#text").property("value")),d3.event.preventDefault()});form.selectAll("input[type=number]").on("click.refresh",function(){this.value!==this.defaultValue&&(generate(),this.defaultValue=this.value)});var stopWords=/^(i|me|my|myself|we|us|our|ours|ourselves|you|your|yours|yourself|yourselves|he|him|his|himself|she|her|hers|herself|it|its|itself|they|them|their|theirs|themselves|what|which|who|whom|whose|this|that|these|those|am|is|are|was|were|be|been|being|have|has|had|having|do|does|did|doing|will|would|should|can|could|ought|i'm|you're|he's|she's|it's|we're|they're|i've|you've|we've|they've|i'd|you'd|he'd|she'd|we'd|they'd|i'll|you'll|he'll|she'll|we'll|they'll|isn't|aren't|wasn't|weren't|hasn't|haven't|hadn't|doesn't|don't|didn't|won't|wouldn't|shan't|shouldn't|can't|cannot|couldn't|mustn't|let's|that's|who's|what's|here's|there's|when's|where's|why's|how's|a|an|the|and|but|if|or|because|as|until|while|of|at|by|for|with|about|against|between|into|through|during|before|after|above|below|to|from|up|upon|down|in|out|on|off|over|under|again|further|then|once|here|there|when|where|why|how|all|any|both|each|few|more|most|other|some|such|no|nor|not|only|own|same|so|than|too|very|say|says|said|shall)$/,punctuation=new RegExp("["+unicodePunctuationRe+"]","g"),wordSeparators=/[ \f\n\r\t\v\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000\u3031-\u3035\u309b\u309c\u30a0\u30fc\uff70]+/g,discard=/^(@|https?:|\/\/)/,htmlTags=/(<[^>]*?>|<script.*?<\/script>|<style.*?<\/style>|<head.*?><\/head>)/g,matchTwitter=/^https?:\/\/([^\.]*\.)?twitter\.com/;d3.select("#random-palette").on("click",function(){paletteJSON("http://www.colourlovers.com/api/palettes/random",{},function(a){fill.range(a[0].colors),vis.selectAll("text").style("fill",function(b){return fill(b.text.toLowerCase())})}),d3.event.preventDefault()}),function(){function B(){y=5,A=Math.max(-90,Math.min(90,-60)),m=Math.max(-90,Math.min(90,60)),v()}function v(){p.domain([0,y-1]).range([A,m]);var a=k.selectAll("path.angle").data([{startAngle:A*x,endAngle:m*x}]);a.enter().insert("path","circle").attr("class","angle").style("fill","#fc0"),a.attr("d",q);var d=k.selectAll("line.angle").data(d3.range(y).map(p));d.enter().append("line").attr("class","angle"),d.exit().remove(),d.attr("transform",function(e){return"rotate("+(90+e)+")"}).attr("x2",function(f,i){return i&&i!==y-1?-b:-b-5});var c=k.selectAll("path.drag").data([A,m]);c.enter().append("path").attr("class","drag").attr("d","M-9.5,0L-3,3.5L-3,-3.5Z").call(d3.behavior.drag().on("drag",function(f,n){f=(n?m:A)+90;var i=[-b*Math.cos(f*x),-b*Math.sin(f*x)],e=[d3.event.x,d3.event.y],r=~~(Math.atan2(j(i,e),z(i,e))/x);f=Math.max(-90,Math.min(90,f+r-90)),r=m-A,n?(m=f,r>360?A+=r-360:0>r&&(A=m)):(A=f,r>360?m+=360-r:0>r&&(m=A)),v()}).on("dragend",generate)),c.attr("transform",function(e){return"rotate("+(e+90)+")translate(-"+b+")"}),layout.rotate(function(){return p(~~(Math.random()*y))}),5,-60,60}function j(a,c){return a[0]*c[1]-a[1]*c[0]}function z(a,c){return a[0]*c[0]+a[1]*c[1]}var b=40.5,g=35,C=20,k=d3.select("#angles").append("svg").attr("width",2*(b+g)).attr("height",b+1.5*C).append("g").attr("transform","translate("+[b+g,b+C]+")");k.append("path").style("fill","none").attr("d",["M",-b,0,"A",b,b,0,0,1,b,0].join(" ")),k.append("line").attr("x1",-b-7).attr("x2",b+7),k.append("line").attr("y2",-b-7),k.selectAll("text").data([-90,0,90]).enter().append("text").attr("dy",function(a,c){return 1===c?null:".3em"}).attr("text-anchor",function(a,c){return["end","middle","start"][c]}).attr("transform",function(a){return a+=90,"rotate("+a+")translate("+-(b+10)+")rotate("+-a+")translate(2)"}).text(function(a){return a+"\xb0"});var A,m,y,x=Math.PI/180,p=d3.scale.linear(),q=d3.svg.arc().innerRadius(0).outerRadius(b);B(),parseText(d3.select("#text").property("value"))}();